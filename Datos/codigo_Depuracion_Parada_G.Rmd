---
title: "Parada_G_m8_reto2"
author: "Gabriel Parada"
date: "2025-07-06"
output: html_document
---

```{r setup, include=FALSE}

#Instalar y cargar paquetes:

#install.packages('readxl')
#install.packages('dplyr')
#install.packages('ggplot2')
#install.packages("plotly")

library(tidyr)
library(plotly)
library('readxl')
library('dplyr')
library('ggplot2')

```


```{r , echo=FALSE, warning=FALSE}

#Cargar los 2 dataset de excel completos con todos los países 
dfLarga <- read_excel("GM-Life Expectancy- Dataset-v14.xlsx", sheet = "live unpivot") 
dfGDP <-  read_excel("gdp_pcap.xlsx", sheet = "gdp_pcap") 

#Formatear los nombres de columnas
colnames(dfLarga)[4] <- "life_expectancy"
colnames(dfLarga)[2] <- "country"

#Columnas en factores
dfLarga$geo <- as.factor(dfLarga$geo)
dfLarga$country <- as.factor(dfLarga$country)

#Valores a 2 decimales:
dfLarga[,4] <- round(dfLarga[,4],2)

#Cambiar esperanza de vida 0 por Na's
dfLarga[dfLarga == 0] <- NA

# Se filtran los 10 países de más con más habitantes de Suramérica y las medias de continentes
paises <- c("Argentina", "Bolivia","Brazil", "Chile", "Colombia", "Ecuador", "Guyana", "Peru","Uruguay", "Venezuela", "World", "Asia", "Europe", "The Americas", "Africa")

dfLAmerica <- dfLarga[(dfLarga$country %in% paises),]

mediaSur <- data.frame(geo= rep("sur", 301),name=rep("Suramérica",301),
                       year=seq(1800, 2100))

df_m <- dfLAmerica %>%
    group_by(year) %>%
    summarise(life_expectancy = mean(life_expectancy, na.rm = T))

mediaSur <- mediaSur %>%
    left_join(df_m, by = "year")

# Nombres de las columnas como texto (porque tienen diferentes formatos)
colnames(dfGDP) <- as.character(colnames(dfGDP))

# Pivot a formato largo 
dfGDP_long <- dfGDP %>%
  pivot_longer(
    cols = matches("^[0-9]{4}$"),  
    names_to = "year",
    values_to = "GDP_raw",         
    values_transform = list(GDP_raw = as.character)  
  ) %>%
  mutate(year = as.integer(year))

# Se transforman los valores porque algunos GDP tienen carácteres en las cantidades que deberían ser solo números
dfGDP_long <- dfGDP_long %>%
  mutate(GDP = case_when(
    grepl("k", GDP_raw, ignore.case = TRUE) ~ as.numeric(sub("k", "", GDP_raw, ignore.case = TRUE)) * 1000,
    TRUE ~ as.numeric(GDP_raw)
  )) %>%
  select(-GDP_raw)  


# Merge por año y país 
df_LA_GDP <- dfLAmerica %>% 
  left_join(dfGDP_long, by = c("country", "year"))


# Guardar la base de datos depurada
write.csv(df_LA_GDP,"df_LA_GDP.csv", row.names = F, fileEncoding = "UTF-8")

```














